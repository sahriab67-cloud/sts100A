<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tempahan_STS100A ‚Äî v4.4</title>
<style>
:root{--header:#0f3b77;--bg:#f7f9fc;--seat-size:32px;--price:180;--booked:#bdbdbd;--selected:#2ecc71;--vvip:#fdf3d7;--vvip-border:#fcd34d}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
body{margin:0;background:var(--bg);color:#0f172a}
header{background:var(--header);color:#fff;display:flex;align-items:center;gap:12px;padding:12px 18px;justify-content:space-between}
.header-center{flex:1;text-align:center}
.tents-layout{display:grid;grid-template-columns:repeat(5,1fr);gap:20px;justify-items:center;align-items:start;max-width:1200px;margin:14px auto}
.tent{width:260px;padding:12px;border-radius:10px;position:relative;min-height:240px;display:flex;flex-direction:column;align-items:center}
.table-card{position:relative;width:100px;height:100px;border-radius:50%;background:#f9fafb;border:2px solid #e2e8f0;margin:10px;display:flex;align-items:center;justify-content:center}
.table-center{width:30px;height:30px;border-radius:50%;background:#fff;border:1px solid #cbd5e1;display:flex;align-items:center;justify-content:center;font-size:11px;position:relative;z-index:2}
.seat{position:absolute;width:var(--seat-size);height:var(--seat-size);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;border:1px solid #3b82f6;background:#fff;color:#0f172a;cursor:pointer;user-select:none;transform:translate(-50%,-50%);z-index:1}
.seat.booked{background:var(--booked);color:#fff;cursor:not-allowed}
.seat.selected{background:var(--selected);color:#fff}
.invalid-resit{color:#9b1c1c;margin-top:6px;font-weight:600;display:none}
.controls{display:flex;gap:10px;align-items:center;justify-content:center;margin:12px 0;flex-wrap:wrap}
button.primary{background:var(--header);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
button.ghost{background:#fff;border:1px solid #e6eefc;color:var(--header);padding:9px 12px;border-radius:8px;cursor:pointer}
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;z-index:60}
.modal{width:520px;background:#fff;border-radius:10px;padding:16px;box-shadow:0 10px 40px rgba(2,6,23,.3)}
@media(max-width:960px){.tents-layout{grid-template-columns:repeat(2,1fr)}.modal{width:92%}.tent{width:90%}}
</style>
</head>
<body>
<header>
  <div class="header-center">
    <h1>Tempahan STS100A ‚Äî Majlis 100 Tahun (1926‚Äì2026)</h1>
    <p>Hubungi Alumni STS: 07-9312472</p>
  </div>
</header>

<main>
  <div class="note" style="max-width:1200px;margin:8px auto;padding:0 12px">Hanya resit Pakej A <strong>STS100A001‚ÄìSTS100A288</strong> dibenarkan. Harga RM180/kerusi. Khemah C VVIP (tiada meja/kerusi).</div>
  <div class="controls">
    <button class="primary" id="openBookingBtn">Buka Borang Tempahan</button>
    <button class="ghost" id="downloadAllBtn">üíæ Muat Turun Semua Tempahan (CSV)</button>
    <button class="ghost" id="adminViewBtn">üîí Paparan Admin</button>
  </div>

  <div class="tents-layout" id="tentsContainer" aria-live="polite"></div>
</main>

<!-- Booking modal -->
<div class="modal-backdrop" id="bookingBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Borang Tempahan</h3>
    <form id="bookingForm">
      <div><label>Nama Penuh</label><input id="fName" required></div>
      <div><label>No. Telefon</label><input id="fPhone" required></div>
      <div><label>Batch / Tahun</label><input id="fBatch" required></div>
      <div><label>No. Resit / Rujukan (STS100Axxx)</label><input id="fResit" required></div>
      <div id="resitError" class="invalid-resit">‚ö†Ô∏è Nombor resit tidak sah untuk Pakej A. Sila hubungi urusetia alumni.</div>
      <div style="margin-top:10px" id="selectedSummary">Tiada kerusi dipilih.</div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button type="button" class="ghost" id="bookingCancel">Batal</button>
        <button type="submit" class="primary">Sahkan Tempahan & Hantar</button>
      </div>
    </form>
  </div>
</div>

<!-- Admin modal -->
<div class="modal-backdrop" id="adminBackdrop" aria-hidden="true">
  <div class="modal">
    <h3>Paparan Admin</h3>
    <div style="margin-bottom:8px"><label>Kata Laluan Admin</label><input id="adminPass" type="password"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="ghost" id="adminCancel">Tutup</button>
      <button class="primary" id="adminLogin">Log Masuk</button>
    </div>
    <div style="margin-top:10px;font-size:13px;color:#6b7280">(Kata laluan admin: <strong>STSADMIN2025</strong>)</div>
  </div>
</div>

<footer style="text-align:center;padding:12px;background:#0f3b77;color:#fff;margin-top:18px">¬© 2026 Sekolah Tinggi Segamat ‚Äî Tempahan STS100A</footer>

<script>
/* CONFIG */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyQVcAD5rFj3cb0eKRoVTLpWBNb7v7j25C1omfefCcD94dEg2ETCEsgEgbkx9Xj15vWLw/exec";
const STORAGE_BOOKINGS = 'Tempahan_STS100A_bookings_v4';
const ADMIN_PASS = 'STSADMIN2025';
const PRICE = 180;
const MEJA_PER_KHEMAH = 4;
const SEATS_PER_TABLE = 8;
const tentMap = [['A','B','C','D','E'],['F','G','H','I','J']];

/* helpers */
const $ = (s,ctx=document)=>ctx.querySelector(s);
function loadBookings(){ try{ return JSON.parse(localStorage.getItem(STORAGE_BOOKINGS))||[] }catch{return[]} }
function saveBookings(b){ localStorage.setItem(STORAGE_BOOKINGS, JSON.stringify(b)) }

/* UI + Data */
const tentsContainer = $('#tentsContainer');
let selectedSeats = new Set();
let serverBookedSet = new Set(); // authoritative bookings from GS

/* Build layout using serverBookedSet + local selections */
function buildLayout(){
  tentsContainer.innerHTML = '';
  for(const row of tentMap){
    for(const tName of row){
      const tent = document.createElement('div'); tent.className = 'tent tent-'+tName;
      if(tName==='C'){
        tent.className='tent tent-C';
        tent.innerHTML=`<div style="font-weight:700">Khemah ${tName} <span style="color:#92400e">(VVIP)</span></div><div style="margin-top:6px">Tanpa meja / kerusi</div>`;
        tentsContainer.appendChild(tent);
        continue;
      }
      tent.innerHTML = `<div style="font-weight:700">Khemah ${tName}</div><div class="tent-inner" style="display:flex;flex-wrap:wrap;justify-content:center"></div>`;
      const inner = tent.querySelector('.tent-inner');
      for(let m=1;m<=MEJA_PER_KHEMAH;m++){
        const table=document.createElement('div'); table.className='table-card';
        const center=document.createElement('div'); center.className='table-center'; center.textContent='T'+m; table.appendChild(center);
        const radius = 38;
        for(let s=1;s<=SEATS_PER_TABLE;s++){
          const seatId = `${tName}-T${m}-S${s}`;
          const angle = (s-1)*(2*Math.PI/SEATS_PER_TABLE);
          const cx=50, cy=50;
          const x = cx + Math.cos(angle)*radius;
          const y = cy + Math.sin(angle)*radius;
          const seat = document.createElement('div');
          const isBooked = serverBookedSet.has(seatId);
          seat.className = 'seat' + (isBooked? ' booked' : '');
          if(selectedSeats.has(seatId)) seat.classList.add('selected');
          seat.style.left = x + 'px'; seat.style.top = y + 'px';
          seat.textContent = `${tName}${m}${s}`;
          seat.dataset.seatid = seatId;
          seat.dataset.khemah = tName; seat.dataset.meja = m; seat.dataset.kerusi = s;
          seat.title = `Khemah ${tName} ‚Äî Meja ${m} ‚Äî Kerusi ${s}`;
          seat.addEventListener('click', onSeatClick);
          table.appendChild(seat);
        }
        inner.appendChild(table);
      }
      tentsContainer.appendChild(tent);
    }
  }
  updateSelectedSummary();
}

/* seat click */
function onSeatClick(e){
  const el = e.currentTarget;
  if(el.classList.contains('booked')){ alert(`Maaf, ${el.dataset.seatid} telah ditempah.`); return; }
  const id = el.dataset.seatid;
  if(selectedSeats.has(id)){ selectedSeats.delete(id); el.classList.remove('selected'); }
  else { selectedSeats.add(id); el.classList.add('selected'); }
  updateSelectedSummary();
}
function updateSelectedSummary(){
  const el = $('#selectedSummary');
  if(!el) return;
  if(selectedSeats.size===0) el.textContent='Tiada kerusi dipilih.';
  else el.textContent = `Kerusi dipilih: ${Array.from(selectedSeats).join(', ')} ‚Äî Jumlah RM${selectedSeats.size*PRICE}`;
}

/* Booking modal */
const bookingBackdrop = $('#bookingBackdrop');
const bookingForm = $('#bookingForm');
const resitError = $('#resitError');
$('#openBookingBtn').addEventListener('click', ()=>{ bookingBackdrop.style.display='flex'; $('#fName').focus(); updateSelectedSummary(); });
$('#bookingCancel').addEventListener('click', ()=>{ bookingBackdrop.style.display='none'; });

function isValidResit(resit){
  if(!resit) return false;
  const r = resit.trim().toUpperCase();
  if(!r.startsWith('STS100A')) return false;
  const num = r.slice(7);
  if(!/^\d{3}$/.test(num)) return false;
  const v = parseInt(num,10);
  return v>=1 && v<=288;
}
function showResitError(show){ resitError.style.display = show? 'block':'none'; }

/* Submit booking: send (no-cors) to server; server will validate resit again */
bookingForm.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  showResitError(false);
  if(selectedSeats.size===0){ alert('Sila pilih sekurang-kurangnya satu kerusi.'); return; }
  const name = $('#fName').value.trim(), phone = $('#fPhone').value.trim(), batch = $('#fBatch').value.trim(), resitRaw = $('#fResit').value.trim();
  if(!name||!phone||!batch){ alert('Sila lengkapkan Nama, Telefon dan Batch.'); return; }
  if(!isValidResit(resitRaw)){ showResitError(true); alert('‚ö†Ô∏è Nombor resit tidak sah untuk Pakej A.\nSila hubungi urusetia alumni.'); return; }

  const seatsArray = Array.from(selectedSeats);
  const code = 'STS100-' + Math.random().toString(36).slice(2,9).toUpperCase();
  let sentCount = 0;

  for(const seat of seatsArray){
    const [k,tm,st] = seat.split('-');
    const payload = { nama:name, telefon:phone, batch:batch, resit:resitRaw.toUpperCase(), khemah:k, meja:tm.replace('T',''), kerusi:st.replace('S',''), kod_tempahan:code, harga:PRICE, masa:new Date().toISOString() };
    const params = new URLSearchParams(payload);
    const url = WEBAPP_URL + '?' + params.toString();
    try {
      // send no-cors so UI doesn't block; server will still write
      await fetch(url, { method: 'GET', mode: 'no-cors' });
      sentCount++;
    } catch(err){
      console.error('Fetch error', err);
    }
  }

  if(sentCount>0){
    // update local saved bookings copy for admin view and immediate UI
    const booking = { code, name, phone, batch, resit:resitRaw.toUpperCase(), seats:Array.from(seatsArray), total:seatsArray.length*PRICE, createdAt:new Date().toISOString() };
    const all = loadBookings(); all.push(booking); saveBookings(all);
    alert(`‚úÖ Tempahan berjaya dihantar (${sentCount} kerusi). Kod: ${code}.`);
    // refresh server bookings asynchronously (use JSONP)
    loadBookingsFromServer();
  } else {
    alert('‚ö†Ô∏è Gagal menghantar data ke pelayan. Sila cuba lagi nanti.');
  }

  // reset
  selectedSeats.clear();
  $('#fName').value=''; $('#fPhone').value=''; $('#fBatch').value=''; $('#fResit').value='';
  bookingBackdrop.style.display='none';
  buildLayout();
});

/* JSONP load: create script tag to call server?callback=handleLoadBookings */
function handleLoadBookings(data){
  // data = array of booking objects from server
  serverBookedSet.clear();
  if(Array.isArray(data)){
    data.forEach(b=>{
      if(b.khemah && b.meja && b.kerusi){
        const seatId = `${b.khemah}-T${b.meja}-S${b.kerusi}`;
        serverBookedSet.add(seatId);
      }
    });
  }
  buildLayout();
}

function loadBookingsFromServer(){
  // append JSONP script
  const cbName = 'handleLoadBookings';
  const s = document.createElement('script');
  s.src = WEBAPP_URL + '?action=load&callback=' + cbName + '&_=' + Date.now();
  s.onerror = ()=>{ console.error('Gagal load bookings (JSONP)'); };
  document.body.appendChild(s);
  // remove script after load to keep DOM clean
  setTimeout(()=>{ document.body.removeChild(s); }, 15000);
}

/* Admin modal + show bookings from server (JSONP) */
$('#adminViewBtn').addEventListener('click', ()=>{ $('#adminBackdrop').style.display='flex'; $('#adminPass').focus(); });
$('#adminCancel').addEventListener('click', ()=>{ $('#adminBackdrop').style.display='none'; $('#adminPass').value=''; });

$('#adminLogin').addEventListener('click', ()=>{
  const val = $('#adminPass').value;
  if(val !== ADMIN_PASS){ alert('Kata laluan admin salah.'); $('#adminPass').value=''; return; }
  // fetch bookings from server via JSONP and show summary
  const cb = function(data){
    if(!Array.isArray(data) || data.length===0){ alert('Tiada tempahan di server.'); return; }
    let msg = 'Ringkasan Tempahan (Server):\\n';
    data.forEach(b=>{ msg += `${b.kod || b.kod_tempahan || b.kod}: ${b.nama} ‚Äî ${b.batch} ‚Äî ${b.khemah}${b.meja}${b.kerusi}\\n`; });
    alert(msg);
  };
  // create unique callback name to avoid collision
  const cbName = 'adminCB_' + Date.now();
  window[cbName] = function(d){ cb(d); delete window[cbName]; };
  const s = document.createElement('script');
  s.src = WEBAPP_URL + '?action=load&callback=' + cbName + '&_=' + Date.now();
  document.body.appendChild(s);
  setTimeout(()=>{ try{ document.body.removeChild(s);}catch(e){} },15000);
  // close admin modal
  $('#adminBackdrop').style.display='none'; $('#adminPass').value='';
});

/* Download all bookings (open CSV export) */
$('#downloadAllBtn').addEventListener('click', ()=>{
  const url = WEBAPP_URL + '?action=export';
  window.open(url, '_blank'); // will trigger browser download
});

/* Init */
document.addEventListener('DOMContentLoaded', ()=>{
  loadBookingsFromServer(); // authoritative bookings
  buildLayout();
});
</script>
</body>
</html>
