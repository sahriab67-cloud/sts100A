<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tempahan_STS100A (v3) — Majlis 100 Tahun STS</title>
<style>
  :root{
    --header:#0f3b77; --bg:#f7f9fc; --seat-size:32px; --price:180;
    --booked:#bdbdbd; --selected:#2ecc71;
    --vvip:#fdf3d7; --vvip-border:#fcd34d;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
  body{margin:0;background:var(--bg);color:#0f172a}
  header{background:var(--header);color:#fff;display:flex;align-items:center;gap:12px;padding:12px 18px;justify-content:space-between}
  header img{height:72px;width:auto}
  .header-center{flex:1;text-align:center}
  .header-center h1{margin:4px 0;font-size:18px}
  .header-center p{margin:0;font-size:13px;opacity:.95}
  main{max-width:1200px;margin:16px auto;padding:12px}
  .note{max-width:1200px;margin:0 auto 12px;padding:0 12px;color:#374151}
  .legend{display:flex;gap:12px;align-items:center;margin-bottom:12px;max-width:1200px;margin-left:auto;margin-right:auto}
  .legend span{display:inline-flex;align-items:center;gap:8px}
  .tents-layout{display:grid;grid-template-columns:repeat(5,1fr);gap:20px;justify-items:center;align-items:start;max-width:1200px;margin:14px auto}
  .tent{width:260px;padding:12px;border-radius:10px;position:relative;min-height:240px;display:flex;flex-direction:column;align-items:center}
  .tent-name{font-weight:700;text-align:center;margin-bottom:8px}
  .tent-inner{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-content:center}
  /* pastel tents + border */
  .tent-A{background:#d1fae5;border:4px solid #34d399}
  .tent-B{background:#dbeafe;border:4px solid #3b82f6}
  .tent-D{background:#ede9fe;border:4px solid #8b5cf6}
  .tent-E{background:#fef9c3;border:4px solid #eab308}
  .tent-F{background:#ffe4e6;border:4px solid #f43f5e}
  .tent-G{background:#cffafe;border:4px solid #06b6d4}
  .tent-H{background:#dcfce7;border:4px solid #22c55e}
  .tent-I{background:#f1f5f9;border:4px solid #94a3b8}
  .tent-J{background:#fff3f0;border:4px solid #fb923c}
  /* VVIP C */
  .tent-C{background:var(--vvip);border:4px solid var(--vvip-border);display:flex;flex-direction:column;align-items:center;justify-content:center}
  .vvip-note{font-weight:700;color:#92400e;text-align:center}
  .vvip-sub{font-size:13px;color:#7c2d12;margin-top:6px;text-align:center}
  .table-card{
    position:relative;
    width:100px;
    height:100px;
    border-radius:50%;
    background:#f9fafb;
    border:2px solid #e2e8f0;
    margin:10px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .table-center{
    width:30px;
    height:30px;
    border-radius:50%;
    background:#fff;
    border:1px solid #cbd5e1;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:11px;
    position:relative;
    z-index:2;
  }
  .seat{
    position:absolute;
    width:var(--seat-size);
    height:var(--seat-size);
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:10px;
    border:1px solid #3b82f6;
    background:#fff;
    color:#0f172a;
    cursor:pointer;
    user-select:none;
    transform:translate(-50%,-50%);
    z-index:1;
  }
  .seat.booked{background:var(--booked);color:#fff;cursor:not-allowed}
  .seat.selected{background:var(--selected);color:#fff}
  .controls{display:flex;gap:10px;align-items:center;justify-content:center;margin:12px 0;flex-wrap:wrap}
  button.primary{background:var(--header);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.ghost{background:#fff;border:1px solid #e6eefc;color:var(--header);padding:9px 12px;border-radius:8px;cursor:pointer}
  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{width:520px;background:#fff;border-radius:10px;padding:16px;box-shadow:0 10px 40px rgba(2,6,23,.3)}
  .modal h3{margin:0 0 8px;font-size:18px}
  .field{margin-bottom:10px}
  label{display:block;font-size:13px;margin-bottom:6px}
  input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefc}
  .small{font-size:13px;color:#475569}
  footer{background:var(--header);color:#fff;text-align:center;padding:12px;margin-top:18px}
  @media(max-width:960px){ .tents-layout{grid-template-columns:repeat(2,1fr)} header img{height:56px} .modal{width:92%} .tent{width:90%} }
</style>
</head>
<body>

<header>
  <img src="logo_sts.png" alt="Logo STS" onerror="this.style.display='none'">
  <div class="header-center">
    <h1>Tempahan STS100A — Majlis 100 Tahun (1926–2026)</h1>
    <p>Hubungi Alumni STS: 07-9312472</p>
  </div>
  <img src="logo_100yrs.png" alt="100 Tahun STS" onerror="this.style.display='none'">
</header>

<main>
  <div class="note">Sila pilih kerusi yang kosong. Harga RM180/kerusi. Khemah C ditandakan VVIP — <strong>tidak menerima tempahan</strong>.</div>

  <div class="controls">
    <button class="primary" id="openBookingBtn">Buka Borang Tempahan</button>
  </div>

  <div class="legend">
    <span><span style="display:inline-block;width:16px;height:16px;border-radius:4px;background:#fff;border:1px solid #dbeafe"></span> Kosong</span>
    <span><span style="display:inline-block;width:16px;height:16px;border-radius:4px;background:var(--selected)"></span> Dipilih</span>
    <span><span style="display:inline-block;width:16px;height:16px;border-radius:4px;background:var(--booked)"></span> Telah Ditempah</span>
    <span><span style="display:inline-block;width:16px;height:16px;border-radius:4px;background:var(--vvip);border:2px solid var(--vvip-border)"></span> Khemah C (VVIP)</span>
  </div>

  <div class="tents-layout" id="tentsContainer" aria-live="polite"></div>
</main>

<!-- Booking modal -->
<div class="modal-backdrop" id="bookingBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="bookingTitle">
    <h3 id="bookingTitle">Borang Tempahan</h3>
    <form id="bookingForm">
      <div class="field"><label>Nama Penuh</label><input id="fName" required></div>
      <div class="field"><label>No. Telefon</label><input id="fPhone" required></div>
      <div class="field"><label>Batch / Tahun</label><input id="fBatch" required></div>
      <div class="field"><label>No. Resit / Rujukan (jika ada)</label><input id="fResit"></div>
      <div class="field small" id="selectedSummary">Tiada kerusi dipilih.</div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button type="button" class="ghost" id="bookingCancel">Batal</button>
        <button type="submit" class="primary" id="confirmBtn">Sahkan Tempahan & Hantar</button>
      </div>
    </form>
  </div>
</div>

<footer>© 2026 Sekolah Tinggi Segamat — Tempahan STS100A</footer>

<script>
/* ----------------- CONFIG ----------------- */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyw6mBRwPKxm7pjcIN9LWoeyPUGX560ZggGe_6TGhSO9i4YFIJPU0_r_fy6cMxKccwp/exec';
const STORAGE_BOOKINGS = 'Tempahan_STS100A_bookings_v3';
const PRICE = 180;
const MEJA_PER_KHEMAH = 4;
const SEATS_PER_TABLE = 8;
// layout: top row A B C D E, bottom row F G H I J (C is VVIP)
const tentMap = [['A','B','C','D','E'], ['F','G','H','I','J']];

/* helpers */
const $ = (s,ctx=document)=>ctx.querySelector(s);
const $all = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));

function loadBookings(){ try{ return JSON.parse(localStorage.getItem(STORAGE_BOOKINGS))||[] }catch{return[]} }
function saveBookings(b){ localStorage.setItem(STORAGE_BOOKINGS, JSON.stringify(b)) }

/* layout */
const tentsContainer = $('#tentsContainer');
let selectedSeats = new Set();

function buildLayout(){
  tentsContainer.innerHTML = '';
  const bookings = loadBookings();
  const bookedSet = new Set(bookings.flatMap(b=>b.seats));

  for(const row of tentMap){
    for(const tName of row){
      const tent = document.createElement('div');
      tent.className = 'tent tent-' + tName;
      if(tName === 'C'){
        tent.className = 'tent tent-C';
        tent.innerHTML = `<div class="tent-name">Khemah ${tName} <span style="font-weight:600;color:#92400e">(VVIP)</span></div>
                          <div class="vvip-note">Kawasan Tetamu Kehormat</div>
                          <div class="vvip-sub">Tanpa meja / kerusi — Tiada tempahan</div>`;
        tentsContainer.appendChild(tent);
        continue;
      }

      tent.innerHTML = `<div class="tent-name">Khemah ${tName}</div><div class="tent-inner"></div>`;
      const inner = tent.querySelector('.tent-inner');

      // create MEJA_PER_KHEMAH tables
      for(let m=1;m<=MEJA_PER_KHEMAH;m++){
        const table = document.createElement('div');
        table.className = 'table-card';
        const center = document.createElement('div');
        center.className = 'table-center';
        center.textContent = 'T'+m;
        table.appendChild(center);

        // seats around the table (absolute positions inside table)
        const radius = 38; // px
        for(let s=1;s<=SEATS_PER_TABLE;s++){
          const seatId = `${tName}-T${m}-S${s}`;
          const angle = (s-1)*(2*Math.PI/SEATS_PER_TABLE);
          const cx = 50; // center x in px (within 100px table)
          const cy = 50; // center y
          const x = cx + Math.cos(angle) * radius;
          const y = cy + Math.sin(angle) * radius;
          const seat = document.createElement('div');
          const isBooked = bookedSet.has(seatId);
          seat.className = 'seat' + (isBooked? ' booked' : '');
          seat.style.left = x + 'px';
          seat.style.top = y + 'px';
          seat.textContent = `${tName}${m}${s}`;
          seat.title = `Khemah ${tName} — Meja ${m} — Kerusi ${s}`;
          seat.dataset.seatid = seatId;
          seat.dataset.khemah = tName;
          seat.dataset.meja = m;
          seat.dataset.kerusi = s;
          seat.addEventListener('click', onSeatClick);
          table.appendChild(seat);
        }

        inner.appendChild(table);
      }

      tentsContainer.appendChild(tent);
    }
  }

  updateSelectedSummary();
}

/* seat click */
function onSeatClick(e){
  const el = e.currentTarget;
  if(el.classList.contains('booked')){ alert(`Maaf, ${el.dataset.seatid} telah ditempah.`); return; }
  const id = el.dataset.seatid;
  if(selectedSeats.has(id)){ selectedSeats.delete(id); el.classList.remove('selected'); }
  else { selectedSeats.add(id); el.classList.add('selected'); }
  updateSelectedSummary();
}

function updateSelectedSummary(){
  const el = $('#selectedSummary');
  if(!el) return;
  if(selectedSeats.size===0) el.textContent = 'Tiada kerusi dipilih.';
  else el.textContent = `Kerusi dipilih: ${Array.from(selectedSeats).join(', ')} — Jumlah RM${selectedSeats.size * PRICE}`;
}

/* booking modal */
const bookingBackdrop = $('#bookingBackdrop');
const bookingForm = $('#bookingForm');
$('#openBookingBtn').addEventListener('click', ()=> { bookingBackdrop.style.display='flex'; $('#fName').focus(); updateSelectedSummary(); });
$('#bookingCancel').addEventListener('click', ()=> { bookingBackdrop.style.display='none'; });

function tutupPopup(){
  bookingBackdrop.style.display = 'none';
}

/* submit handling - use GET to avoid CORS */
bookingForm.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  if(selectedSeats.size===0){ alert('Sila pilih sekurang-kurangnya satu kerusi terlebih dahulu.'); return; }
  const name = $('#fName').value.trim();
  const phone = $('#fPhone').value.trim();
  const batch = $('#fBatch').value.trim();
  const resit = $('#fResit').value.trim() || '';
  if(!name||!phone||!batch){ alert('Sila lengkapkan Nama, Telefon dan Batch.'); return; }

  const seatsArray = Array.from(selectedSeats);
  const code = 'STS100-' + Math.random().toString(36).slice(2,9).toUpperCase();

  let successSeats = [];
  let failedSeats = [];

  for(const seat of seatsArray){
    const [k,tm,st] = seat.split('-'); // k like "A", tm like "T1", st like "S2"
    const payload = {
      nama: name,
      telefon: phone,
      batch: batch,
      resit: resit,
      khemah: k,
      meja: tm.replace('T',''),
      kerusi: st.replace('S',''),
      kod_tempahan: code,
      harga: PRICE,
      masa: new Date().toISOString()
    };

    try{
      // send as GET query to avoid CORS restrictions
      const params = new URLSearchParams(payload);
      const resp = await fetch(WEBAPP_URL + "?" + params.toString(), { method: "GET" });
      const txt = (await resp.text()).trim();

      if(txt === 'OK' || txt.includes('OK')){
        successSeats.push(seat);
      } else if(txt === 'DUPLICATE' || txt.includes('DUPLICATE')){
        failedSeats.push({seat, reason: 'DUPLICATE'});
        alert(`⚠️ Maaf, ${seat} telah ditempah oleh pengguna lain. Sila pilih tempat duduk lain.`);
        // remove selection visually
        selectedSeats.delete(seat);
        const el = document.querySelector(`[data-seatid="${seat}"]`);
        if(el) el.classList.remove('selected');
      } else {
        failedSeats.push({seat, reason: 'UNKNOWN', resp: txt});
        console.warn('Unexpected response for', seat, txt);
      }
    } catch(err){
      failedSeats.push({seat, reason: 'NETWORK', err});
      console.error('Network error sending', seat, err);
    }
  }

  // save successful seats locally
  if(successSeats.length>0){
    const booking = {
      code,
      name, phone, batch, resit,
      seats: successSeats,
      total: successSeats.length * PRICE,
      createdAt: new Date().toISOString()
    };
    const all = loadBookings();
    all.push(booking);
    saveBookings(all);
  }

  // clear selection & UI
  selectedSeats.clear();
  $('#fName').value=''; $('#fPhone').value=''; $('#fBatch').value=''; $('#fResit').value='';
  tutupPopup();
  buildLayout();

  // notify user
  if(successSeats.length>0 && failedSeats.length===0){
    alert(`✅ Tempahan berjaya untuk ${successSeats.length} kerusi. Kod: ${code}.`);
  } else if(successSeats.length>0 && failedSeats.length>0){
    alert(`✅ Sebahagian tempahan berjaya (${successSeats.length}). Sebahagian gagal (${failedSeats.length}).`);
  } else {
    alert('⚠️ Gagal membuat tempahan ke pelayan. Tiada kerusi ditempah. Sila cuba lagi kemudian.');
  }
});

/* init */
document.addEventListener('DOMContentLoaded', buildLayout);
</script>
</body>
</html>

