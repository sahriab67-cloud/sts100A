<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tempahan STS100A ‚Äî Majlis 100 Tahun STS</title>
<style>
:root {
  --header:#0f3b77; --bg:#f7f9fc; --seat-size:32px; --booked:#bdbdbd; --selected:#2ecc71;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
body{margin:0;background:var(--bg);color:#0f172a}
header{background:var(--header);color:#fff;display:flex;align-items:center;gap:12px;padding:12px 18px;justify-content:space-between}
header img{height:72px;width:auto}
.header-center{text-align:center;flex:1}
.header-center h1{margin:4px 0;font-size:18px}
main{max-width:1200px;margin:16px auto;padding:12px}
.note{color:#374151;margin-bottom:12px;text-align:center}
.tents-layout{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;justify-items:center}
.tent{border:4px solid #dbeafe;border-radius:12px;padding:10px;background:#fff;width:240px;text-align:center}
.tent-name{font-weight:700;margin-bottom:6px}
.tent-inner{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;justify-items:center}
.table-card{position:relative;width:100px;height:100px;border-radius:50%;background:#f9fafb;border:2px solid #e2e8f0;margin:auto}
.table-center{width:30px;height:30px;border-radius:50%;background:#fff;border:1px solid #cbd5e1;display:flex;align-items:center;justify-content:center;font-size:11px;margin:auto;position:relative;z-index:2}
.seat{position:absolute;width:var(--seat-size);height:var(--seat-size);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;border:1px solid #3b82f6;background:#fff;color:#0f172a;cursor:pointer;user-select:none;transform:translate(-50%,-50%)}
.seat.booked{background:var(--booked);color:#fff;cursor:not-allowed}
.seat.selected{background:var(--selected);color:#fff}
button.primary{background:var(--header);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
button.ghost{background:#fff;border:1px solid #e6eefc;color:var(--header);padding:9px 12px;border-radius:8px;cursor:pointer}
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:16px}
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;z-index:60}
.modal{width:480px;background:#fff;border-radius:10px;padding:16px;box-shadow:0 10px 40px rgba(2,6,23,.3)}
footer{background:var(--header);color:#fff;text-align:center;padding:12px;margin-top:18px}
</style>
</head>
<body>

<header>
  <img src="logo_sts.png" alt="Logo STS">
  <div class="header-center">
    <h1>Tempahan STS100A ‚Äî Majlis 100 Tahun STS</h1>
    <p>Hubungi Urusetia Alumni STS: 011-55742917(Cg Azlan)/011-21441240(Cg Ajul)</p>
  </div>
  <img src="logo_100yrs.png" alt="Logo 100 Tahun">
</header>

<main>
  <div class="note">Sila pilih kerusi kosong. Harga RM180/kerusi. Khemah C (VVIP) tidak menerima tempahan.</div>

  <div class="controls">
    <button class="primary" id="openBookingBtn">ü™ë Buat Tempahan</button>
    <button class="ghost" id="refreshBtn">üîÑ Muat Semula</button>
    <button class="ghost" id="adminViewBtn">üîí Admin</button>
  </div>

  <div class="tents-layout" id="tentsContainer"></div>
</main>

<!-- Modal tempahan -->
<div class="modal-backdrop" id="bookingBackdrop">
  <div class="modal">
    <h3>Borang Tempahan</h3>
    <form id="bookingForm">
      <label>Nama</label><input id="fName" required>
      <label>Telefon</label><input id="fPhone" required>
      <label>Batch</label><input id="fBatch" required>
      <label>No. Resit Sah</label><input id="fResit" required placeholder="contoh: STS100A025">
      <p id="selectedSummary" class="note">Tiada kerusi dipilih.</p>
      <div style="text-align:right;margin-top:8px">
        <button type="button" class="ghost" id="cancelBooking">Batal</button>
        <button type="submit" class="primary">Sahkan Tempahan</button>
      </div>
    </form>
  </div>
</div>

<footer>¬© 2026 Sekolah Tinggi Segamat ‚Äî Tempahan Pakej A</footer>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbw_6S3FbwAx5Odg1UBHhcI4RND7ShBBLZd7Q9yEfRwRzzny-nXIxFEG7JBBebj6P8aIkQ/exec";
const tentMap = [["A","B","C","D","E"],["F","G","H","I","J"]];
const MEJA = 4, KERUSI = 8, PRICE = 180;

let selected = new Set();
const $ = (s,ctx=document)=>ctx.querySelector(s);

async function fetchBooked(){
  const res = await fetch(WEBAPP_URL+"?action=list");
  return await res.json();
}

async function buildLayout(){
  const data = await fetchBooked();
  const booked = new Set(data.map(d=>d.kodKerusi));
  const cont = $("#tentsContainer"); cont.innerHTML="";
  for(const row of tentMap){
    for(const t of row){
      const tent = document.createElement("div");
      tent.className="tent";
      tent.innerHTML=`<div class="tent-name">Khemah ${t}</div><div class="tent-inner"></div>`;
      const inner = tent.querySelector(".tent-inner");
      if(t==="C"){inner.innerHTML="<em>VVIP ‚Äî Tidak dibuka untuk tempahan</em>"; cont.appendChild(tent); continue;}
      for(let m=1;m<=MEJA;m++){
        const tbl=document.createElement("div"); tbl.className="table-card";
        const c=document.createElement("div"); c.className="table-center"; c.textContent="T"+m; tbl.appendChild(c);
        const r=35;
        for(let s=1;s<=KERUSI;s++){
          const id=`${t}-T${m}-S${s}`;
          const a=(s-1)*(360/KERUSI)*Math.PI/180;
          const x=50+r*Math.cos(a), y=50+r*Math.sin(a);
          const seat=document.createElement("div");
          seat.className="seat"+(booked.has(id)?" booked":"");
          seat.style.left=x+"%"; seat.style.top=y+"%";
          seat.dataset.id=id;
          seat.textContent=t+m+s;
          seat.onclick=()=>toggleSeat(seat);
          tbl.appendChild(seat);
        }
        inner.appendChild(tbl);
      }
      cont.appendChild(tent);
    }
  }
}

function toggleSeat(el){
  if(el.classList.contains("booked")) return alert("Kerusi telah ditempah.");
  const id=el.dataset.id;
  if(selected.has(id)){selected.delete(id); el.classList.remove("selected");}
  else {selected.add(id); el.classList.add("selected");}
  updateSummary();
}

function updateSummary(){
  const el=$("#selectedSummary");
  el.textContent=selected.size?`Kerusi: ${[...selected].join(", ")} ‚Äî Jumlah RM${selected.size*PRICE}`:"Tiada kerusi dipilih.";
}

$("#openBookingBtn").onclick=()=>{$("#bookingBackdrop").style.display="flex";}
$("#cancelBooking").onclick=()=>{$("#bookingBackdrop").style.display="none";}

$("#refreshBtn").onclick=()=>buildLayout();

$("#bookingForm").onsubmit=async e=>{
  e.preventDefault();
  if(!selected.size) return alert("Pilih sekurang-kurangnya satu kerusi.");
  const payload={nama:$("#fName").value.trim(),telefon:$("#fPhone").value.trim(),
  batch:$("#fBatch").value.trim(),resit:$("#fResit").value.trim(),seats:[...selected]};
  const res=await fetch(WEBAPP_URL+"?action=book",{method:"POST",body:JSON.stringify(payload)});
  const txt=await res.text();
  if(txt.includes("OK")) alert("‚úÖ Tempahan berjaya disimpan!");
  else if(txt.includes("INVALID_RECEIPT")) alert("‚ö†Ô∏è Nombor resit tidak sah untuk Pakej A.");
  else if(txt.includes("DUPLICATE_SEAT")) alert("‚ö†Ô∏è Kerusi telah ditempah oleh orang lain.");
  else alert("‚ùå Ralat: "+txt);
  $("#bookingBackdrop").style.display="none"; selected.clear(); buildLayout();
}

buildLayout();
</script>
</body>
</html>

