<script>
/* ---------- CONFIG ---------- */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycby64_g8vOI_CidHL3QhUExCxcBlMKaxdr_kNeAf8_a-VA59IE6tcwmR6MLzrF4ni-Pk9A/exec';
const TENT_MAP = [['A','B','C','D','E'],['F','G','H','I','J']];
const MEJA_PER_TENT = 4;
const SEATS_PER_TABLE = 8;
const PRICE = 180;
const ADMIN_PASS = 'STSADMIN2025';

/* ---------- helpers ---------- */
const $ = (s, ctx=document) => ctx.querySelector(s);

let selectedSeats = new Set();
let serverBooked = new Set();

/* ---------- layout builder ---------- */
function buildTents(){
  const container = $('#tentsContainer');
  container.innerHTML = '';
  for(const row of TENT_MAP){
    for(const tentName of row){
      const tent = document.createElement('div');
      tent.className = 'tent' + (tentName==='C' ? ' tent-vvip' : '');
      tent.innerHTML = `<div class="tent-name">Khemah ${tentName}${tentName==='C' ? ' (VVIP)' : ''}</div>
                        <div class="tent-inner" aria-label="Khemah ${tentName}"></div>`;
      const inner = tent.querySelector('.tent-inner');
      if(tentName === 'C'){
        inner.innerHTML = '<div style="grid-column:1/-1;font-size:13px;color:#92400e">Kawasan Tetamu Kehormat â€” Tiada meja/kerusi</div>';
        container.appendChild(tent);
        continue;
      }

      for(let tableIndex=1; tableIndex<=MEJA_PER_TENT; tableIndex++){
        const table = document.createElement('div');
        table.className = 'table-slot';
        table.dataset.table = tableIndex;

        const center = document.createElement('div');
        center.className='table-center';
        center.textContent = 'T' + tableIndex;
        table.appendChild(center);

        const radius = 38, cx = 55, cy = 55;
        for(let s=1; s<=SEATS_PER_TABLE; s++){
          const angle = (s-1) * (2*Math.PI / SEATS_PER_TABLE);
          const x = cx + Math.cos(angle) * radius;
          const y = cy + Math.sin(angle) * radius;
          const seat = document.createElement('div');
          seat.className = 'seat';
          const seatId = `${tentName}-T${tableIndex}-S${s}`;
          seat.style.left = x + 'px';
          seat.style.top  = y + 'px';
          seat.textContent = `${tentName}${tableIndex}${s}`;
          seat.title = `Khemah ${tentName} â€” Meja ${tableIndex} â€” Kerusi ${s}`;
          seat.dataset.seatid = seatId;
          seat.dataset.tent = tentName;
          seat.dataset.table = tableIndex;
          seat.dataset.seat = s;
          seat.addEventListener('click', onSeatClick);
          table.appendChild(seat);
        }
        inner.appendChild(table);
      }
      container.appendChild(tent);
    }
  }
  markBookedAndSelected();
}

/* ---------- seat selection ---------- */
function markBookedAndSelected(){
  document.querySelectorAll('.seat').forEach(el=>{
    const id = el.dataset.seatid;
    el.classList.remove('booked','selected');
    if(serverBooked.has(id)) el.classList.add('booked');
    else if(selectedSeats.has(id)) el.classList.add('selected');
  });
  updateSummaryText();
}

function onSeatClick(e){
  const el = e.currentTarget;
  const id = el.dataset.seatid;
  if(el.classList.contains('booked')){ alert('Maaf, kerusi ini telah ditempah.'); return; }
  if(selectedSeats.has(id)){ selectedSeats.delete(id); el.classList.remove('selected'); }
  else { selectedSeats.add(id); el.classList.add('selected'); }
  updateSummaryText();
}

function updateSummaryText(){
  const sum = $('#selectedSummary');
  if(!sum) return;
  if(selectedSeats.size === 0) sum.textContent = 'Tiada kerusi dipilih.';
  else sum.textContent = `Kerusi dipilih: ${Array.from(selectedSeats).join(', ')} â€” Jumlah RM${selectedSeats.size * PRICE}`;
}

/* ---------- server sync ---------- */
function handleServerBookings(data){
  serverBooked.clear();
  if(Array.isArray(data)){
    data.forEach(row=>{
      if(row.khemah && row.meja && row.kerusi){
        const sid = `${String(row.khemah)}-T${String(row.meja)}-S${String(row.kerusi)}`;
        serverBooked.add(sid);
      } else if(row.kodKerusi){ serverBooked.add(String(row.kodKerusi)); }
      else if(row.kode || row.kod){ serverBooked.add(String(row.kod || row.kode)); }
    });
  }
  markBookedAndSelected();
}

function loadBookingsFromServer(){
  const cbName = 'handleServerBookings';
  window[cbName] = handleServerBookings;
  const s = document.createElement('script');
  s.src = WEBAPP_URL + '?action=load&callback=' + cbName + '&_=' + Date.now();
  s.onerror = ()=> fetch(WEBAPP_URL + '?action=list')
    .then(r=>r.json()).then(d=>handleServerBookings(d))
    .catch(err=>console.warn('Load bookings failed',err));
  document.body.appendChild(s);
  setTimeout(()=>{ try{ document.body.removeChild(s); }catch(e){} },15000);
}

/* ---------- resit check ---------- */
function isValidResit(resit){
  if(!resit) return false;
  const r = resit.trim().toUpperCase();
  if(!r.startsWith('STS100A')) return false;
  const num = r.slice(7);
  return /^\d{3}$/.test(num) && parseInt(num,10) >= 1 && parseInt(num,10) <= 288;
}

/* ---------- booking submit ---------- */
async function submitBooking(){
  if(selectedSeats.size === 0){ alert('Sila pilih sekurang-kurangnya satu kerusi.'); return; }
  const name = $('#fName').value.trim();
  const phone = $('#fPhone').value.trim();
  const batch = $('#fBatch').value.trim();
  const resitRaw = $('#fResit').value.trim().toUpperCase();
  $('#resitError').style.display = 'none';
  if(!name || !phone || !batch){ alert('Sila lengkapkan Nama, Telefon dan Batch.'); return; }
  if(!isValidResit(resitRaw)){ $('#resitError').style.display='block'; alert('âš ï¸ Nombor resit tidak sah untuk Pakej A.\nSila hubungi urusetia alumni.'); return; }

  const code = 'STS100A-' + Math.random().toString(36).slice(2,9).toUpperCase();
  const seatsArray = Array.from(selectedSeats);

  let sentCount = 0;
  for(const seat of seatsArray){
    const parts = seat.split('-');
    const khemah = parts[0];
    const meja = parts[1].replace('T','');
    const kerusi = parts[2].replace('S','');
    const params = new URLSearchParams({
      nama:name, telefon:phone, batch:batch, resit:resitRaw,
      khemah:khemah, meja:meja, kerusi:kerusi,
      kod_tempahan:code, harga:PRICE, masa:new Date().toISOString()
    });
    try{
      await fetch(WEBAPP_URL + '?' + params.toString(), { method:'GET', mode:'no-cors' });
      sentCount++;
    }catch(err){ console.error(err); }
  }

  if(sentCount > 0){
    alert(`âœ… Tempahan berjaya dihantar (${sentCount} kerusi). Sila tunggu pelan dikemas kini...`);
    selectedSeats.clear(); updateSummaryText();
    $('#bookingBackdrop').style.display='none';
    const note = document.querySelector('.note');
    const oldNote = note.textContent;
    note.textContent = "ðŸ”„ Sedang mengemas kini pelan... sila tunggu sebentar.";
    setTimeout(()=>{
      loadBookingsFromServer();
      note.textContent = oldNote;
    }, 4000);
  } else {
    alert('âš ï¸ Gagal menghantar ke server. Sila cuba lagi.');
  }
}

/* ---------- misc ---------- */
$('#adminBtn').addEventListener('click', ()=>{ $('#adminBackdrop').style.display='flex'; $('#adminPass').focus(); });
$('#adminCancel').addEventListener('click', ()=>{ $('#adminBackdrop').style.display='none'; });
$('#refreshBtn').addEventListener('click', ()=> loadBookingsFromServer());
$('#openBookingBtn').addEventListener('click', ()=>{ $('#bookingBackdrop').style.display='flex'; $('#fName').focus(); updateSummaryText(); });
$('#cancelBooking').addEventListener('click', ()=>{ $('#bookingBackdrop').style.display='none'; });
$('#bookingForm').addEventListener('submit', ev=>{ ev.preventDefault(); submitBooking(); });

document.addEventListener('DOMContentLoaded', ()=>{ buildTents(); loadBookingsFromServer(); });
</script>
